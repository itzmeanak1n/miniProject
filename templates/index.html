<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปหารค่าอาหาร</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            font-family: 'Kanit', sans-serif;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .food-item, .person-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <!-- แบนเนอร์ด้านซ้าย (โหลดผ่าน iframe) -->
    <div class="position-fixed start-0 top-0 h-100 d-none d-lg-block" style="width: 180px; z-index: 1000; left: 0;">
        <iframe src="/banner/left" frameborder="0" style="width: 180px; height: 100%; border: none;"></iframe>
    </div>

    <!-- เนื้อหาหลัก -->
    <div class="container" style="max-width: 1200px; margin: 0 auto; position: relative; z-index: 1;">
        <h1 class="text-center mb-4">❌ Guไม่หารนะ ❌</h1>
        
        <!-- ส่วนเพิ่มเมนูอาหาร -->
        <div class="section">
            <h2>1. เพิ่มเมนูอาหาร</h2>
            <div class="row">
                <div class="col-md-5">
                    <input type="text" id="foodName" class="form-control mb-2" placeholder="ชื่ออาหาร">
                </div>
                <div class="col-md-5">
                    <input type="number" id="foodPrice" class="form-control mb-2" placeholder="ราคา" step="0.01">
                </div>
                <div class="col-md-2">
                    <button onclick="addFood()" class="btn btn-primary w-100">เพิ่มเมนู</button>
                </div>
            </div>
            <div id="foodList" class="mt-3">
                <!-- รายการอาหารจะแสดงที่นี่ -->
            </div>
        </div>

        <!-- ส่วนเพิ่มคน -->
        <div class="section">
            <h2>2. เพิ่มคน</h2>
            <div class="row">
                <div class="col-md-10">
                    <input type="text" id="personName" class="form-control mb-2" placeholder="ชื่อคน">
                </div>
                <div class="col-md-2">
                    <button onclick="addPerson()" class="btn btn-success w-100">เพิ่มคน</button>
                </div>
            </div>
            <div id="peopleList" class="mt-3">
                <!-- รายชื่อคนจะแสดงที่นี่ -->
            </div>
        </div>

        <!-- ส่วนเลือกอาหารที่กิน -->
        <div class="section">
            <h2>3. เลือกอาหารที่แต่ละคนกิน</h2>
            <div id="foodSelection">
                <!-- ฟอร์มการเลือกอาหารจะแสดงที่นี่ -->
            </div>
        </div>

        <!-- ส่วนคำนวณ -->
        <div class="section">
            <h2>4. ผลลัพธ์</h2>
            <button onclick="calculate()" class="btn btn-primary mb-3">คำนวณ</button>
            <div id="result" class="mt-3">
                <!-- ผลลัพธ์จะแสดงที่นี่ -->
            </div>
        </div>
    </div>

    <!-- แบนเนอร์ด้านขวา (โหลดผ่าน iframe) -->
    <div class="position-fixed end-0 top-0 h-100 d-none d-lg-block" style="width: 180px; z-index: 1000; right: 0;">
        <iframe src="/banner/right" frameborder="0" style="width: 180px; height: 100%; border: none;"></iframe>
    </div>

    <script>
        let foods = [];
        let people = [];

        // เพิ่มอาหาร
        function addFood() {
            const name = document.getElementById('foodName').value;
            const price = parseFloat(document.getElementById('foodPrice').value);
            
            if (!name || isNaN(price)) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            fetch('/add_food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, price })
            })
            .then(response => response.json())
            .then(data => {
                foods = data.foods;
                updateFoodList();
                updateFoodSelection();
                document.getElementById('foodName').value = '';
                document.getElementById('foodPrice').value = '';
            });
        }


        // เพิ่มคน
        function addPerson() {
            const name = document.getElementById('personName').value;
            
            if (!name) {
                alert('กรุณากรอกชื่อ');
                return;
            }

            fetch('/add_person', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name })
            })
            .then(response => response.json())
            .then(data => {
                people = data.people;
                updatePeopleList();
                updateFoodSelection();
                document.getElementById('personName').value = '';
            });
        }

        // อัปเดตรายการอาหาร
        function updateFoodList() {
            const foodList = document.getElementById('foodList');
            foodList.innerHTML = '';
            
            if (foods.length === 0) {
                foodList.innerHTML = '<p>ยังไม่มีรายการอาหาร</p>';
                return;
            }
            
            const list = document.createElement('div');
            list.className = 'list-group';
            
            foods.forEach(food => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <span>${food.name} - ฿${food.price.toFixed(2)}</span>
                `;
                list.appendChild(item);
            });
            
            foodList.appendChild(list);
        }

        // อัปเดตรายชื่อคน
        function updatePeopleList() {
            const peopleList = document.getElementById('peopleList');
            peopleList.innerHTML = '';
            
            if (people.length === 0) {
                peopleList.innerHTML = '<p>ยังไม่มีรายชื่อคน</p>';
                return;
            }
            
            const list = document.createElement('div');
            list.className = 'list-group';
            
            people.forEach(person => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.textContent = person.name;
                list.appendChild(item);
            });
            
            peopleList.appendChild(list);
        }


        // อัปเดตส่วนเลือกอาหาร
        function updateFoodSelection() {
            const foodSelection = document.getElementById('foodSelection');
            foodSelection.innerHTML = '';
            
            if (people.length === 0 || foods.length === 0) {
                foodSelection.innerHTML = '<p>กรุณาเพิ่มรายการอาหารและคนก่อน</p>';
                return;
            }
            
            people.forEach(person => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header';
                cardHeader.textContent = `เลือกอาหารสำหรับ: ${person.name}`;
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                foods.forEach(food => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input';
                    checkbox.value = food.id;
                    checkbox.id = `person-${person.id}-food-${food.id}`;
                    
                    // ตรวจสอบว่าอาหารนี้ถูกเลือกไว้แล้วหรือไม่
                    if (person.foods_selected && person.foods_selected.includes(food.id)) {
                        checkbox.checked = true;
                    }
                    
                    checkbox.addEventListener('change', () => updatePersonFoods(person.id));
                    
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = `person-${person.id}-food-${food.id}`;
                    label.textContent = `${food.name} (฿${food.price.toFixed(2)})`;
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    cardBody.appendChild(div);
                });
                
                card.appendChild(cardHeader);
                card.appendChild(cardBody);
                foodSelection.appendChild(card);
            });
        }

        // อัปเดตอาหารที่คนเลือก
        function updatePersonFoods(personId) {
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="person-${personId}-"]`);
            const selectedFoods = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedFoods.push(parseInt(checkbox.value));
                }
            });
            
            fetch('/select_food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    person_id: personId,
                    food_ids: selectedFoods
                })
            });
        }

        // คำนวณผลลัพธ์
        function calculate() {
            fetch('/calculate')
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '';
                    
                    if (!data.people || data.people.length === 0) {
                        resultDiv.innerHTML = '<p>ไม่พบข้อมูลการคำนวณ</p>';
                        return;
                    }
                    
                    // สร้างตารางสรุปยอดรวม
                    const summaryTable = document.createElement('table');
                    summaryTable.className = 'table table-bordered mb-4';
                    
                    const summaryThead = document.createElement('thead');
                    summaryThead.innerHTML = `
                        <tr class="table-primary">
                            <th colspan="2" class="text-center">สรุปรวมค่าอาหารทั้งหมด</th>
                        </tr>
                        <tr>
                            <th>รายการ</th>
                            <th class="text-end">จำนวนเงิน</th>
                        </tr>
                    `;
                    
                    const summaryTbody = document.createElement('tbody');
                    
                    // แสดงยอดรวมค่าอาหารทั้งหมด
                    const totalFoodsRow = document.createElement('tr');
                    totalFoodsRow.innerHTML = `
                        <td>ยอดรวมค่าอาหารทั้งหมด</td>
                        <td class="text-end">฿${data.total_all_foods.toFixed(2)}</td>
                    `;
                    summaryTbody.appendChild(totalFoodsRow);
                    
                    // แสดงยอดรวมที่คำนวณได้ (ควรเท่ากับยอดรวมอาหารทั้งหมด)
                    const calculatedTotalRow = document.createElement('tr');
                    calculatedTotalRow.innerHTML = `
                        <td>ยอดรวมที่คำนวณได้</td>
                        <td class="text-end">฿${data.calculated_total.toFixed(2)}</td>
                    `;
                    summaryTbody.appendChild(calculatedTotalRow);
                    
                    summaryTable.appendChild(summaryThead);
                    summaryTable.appendChild(summaryTbody);
                    resultDiv.appendChild(summaryTable);
                    
                    // สร้างตารางแสดงรายละเอียดการคำนวณของแต่ละคน
                    data.people.forEach(person => {
                        const personCard = document.createElement('div');
                        personCard.className = 'card mb-4';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header bg-light';
                        cardHeader.innerHTML = `<h5 class="mb-0">${person.name} - รวมทั้งสิ้น ฿${person.total.toFixed(2)}</h5>`;
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        if (person.foods && person.foods.length > 0) {
                            const table = document.createElement('table');
                            table.className = 'table table-sm';
                            
                            const thead = document.createElement('thead');
                            thead.innerHTML = `
                                <tr>
                                    <th>รายการอาหาร</th>
                                    <th class="text-end">ราคา</th>
                                    <th class="text-center">จำนวนคนที่แบ่ง</th>
                                    <th class="text-end">จ่ายคนละ</th>
                                </tr>
                            `;
                            
                            const tbody = document.createElement('tbody');
                            
                            person.foods.forEach(food => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${food.name}</td>
                                    <td class="text-end">฿${food.price.toFixed(2)}</td>
                                    <td class="text-center">${food.share_count} คน</td>
                                    <td class="text-end">฿${food.share_amount.toFixed(2)}</td>
                                `;
                                tbody.appendChild(row);
                            });
                            
                            const totalRow = document.createElement('tr');
                            totalRow.className = 'table-active fw-bold';
                            totalRow.innerHTML = `
                                <td colspan="3" class="text-end">รวมทั้งหมด:</td>
                                <td class="text-end">฿${person.total.toFixed(2)}</td>
                            `;
                            tbody.appendChild(totalRow);
                            
                            table.appendChild(thead);
                            table.appendChild(tbody);
                            cardBody.appendChild(table);
                        } else {
                            cardBody.innerHTML = '<p class="mb-0">ไม่พบรายการอาหารที่เลือก</p>';
                        }
                        
                        personCard.appendChild(cardHeader);
                        personCard.appendChild(cardBody);
                        resultDiv.appendChild(personCard);
                    });
                })
                .catch(error => {
                    console.error('Error calculating:', error);
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = `<div class="alert alert-danger">เกิดข้อผิดพลาดในการคำนวณ: ${error.message}</div>`;
                });
        }

        // โหลดข้อมูลเริ่มต้น
        function loadInitialData() {
            fetch('/calculate')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        calculate();
                    }
                });
        }

        // โหลดข้อมูลเมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Application loaded');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
